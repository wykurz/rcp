name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (e.g., v0.23.0)'
        required: true
      skip_validation:
        description: 'Skip validation step (for re-runs after release)'
        type: boolean
        default: false
      dry_run:
        description: 'Build only, do not create or upload to release'
        type: boolean
        default: false

env:
  # Use workflow_dispatch input if provided, otherwise use the tag name
  RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_tag || github.ref_name }}

jobs:
  validate:
    if: ${{ github.event_name != 'workflow_dispatch' || !inputs.skip_validation }}
    uses: ./.github/workflows/validate.yml

  create-release:
    runs-on: ubuntu-latest
    needs: validate
    if: ${{ !cancelled() && (needs.validate.result == 'success' || needs.validate.result == 'skipped') && !(github.event_name == 'workflow_dispatch' && inputs.dry_run) }}
    permissions:
      contents: write
    steps:
      - name: Create Draft Release
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          draft: true
          generate_release_notes: false

  build-deb-amd64:
    runs-on: ubuntu-latest
    needs: [validate, create-release]
    if: ${{ !cancelled() && (needs.validate.result == 'success' || needs.validate.result == 'skipped') && (needs.create-release.result == 'success' || needs.create-release.result == 'skipped') }}
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c # v1
        with:
          target: x86_64-unknown-linux-musl

      - name: Install musl toolchain deps
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools pkg-config
          sudo ln -sf /usr/bin/musl-gcc /usr/bin/x86_64-unknown-linux-musl-gcc

      - name: Install cargo-deb
        run: cargo install cargo-deb

      - name: Build Debian packages
        env:
          PKG_CONFIG_ALLOW_CROSS: "1"
          RUSTFLAGS: "--cfg tokio_unstable -C target-feature=+crt-static"
        run: |
          cargo deb --target=x86_64-unknown-linux-musl -p rcp-tools-rcp
          cargo deb --target=x86_64-unknown-linux-musl -p rcp-tools-rlink
          cargo deb --target=x86_64-unknown-linux-musl -p rcp-tools-rrm
          cargo deb --target=x86_64-unknown-linux-musl -p rcp-tools-rcmp
          cargo deb --target=x86_64-unknown-linux-musl -p rcp-tools-filegen
          zip rcp-deb-amd64-${{ env.RELEASE_TAG }}.zip target/x86_64-unknown-linux-musl/debian/*.deb
          ls -la rcp-deb-amd64-${{ env.RELEASE_TAG }}.zip

      - name: Upload to GitHub Release
        if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.dry_run) }}
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          files: ./rcp-deb-amd64-${{ env.RELEASE_TAG }}.zip

  build-rpm-amd64:
    runs-on: ubuntu-latest
    needs: [validate, create-release]
    if: ${{ !cancelled() && (needs.validate.result == 'success' || needs.validate.result == 'skipped') && (needs.create-release.result == 'success' || needs.create-release.result == 'skipped') }}
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c # v1
        with:
          target: x86_64-unknown-linux-musl

      - name: Install musl toolchain deps
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools pkg-config
          sudo ln -sf /usr/bin/musl-gcc /usr/bin/x86_64-unknown-linux-musl-gcc

      - name: Install cargo-generate-rpm
        run: cargo install cargo-generate-rpm

      - name: Build RPM packages
        env:
          PKG_CONFIG_ALLOW_CROSS: "1"
          RUSTFLAGS: "--cfg tokio_unstable -C target-feature=+crt-static"
        run: |
          cargo build --release --target=x86_64-unknown-linux-musl
          cargo generate-rpm --target=x86_64-unknown-linux-musl -p rcp
          cargo generate-rpm --target=x86_64-unknown-linux-musl -p rlink
          cargo generate-rpm --target=x86_64-unknown-linux-musl -p rrm
          cargo generate-rpm --target=x86_64-unknown-linux-musl -p rcmp
          cargo generate-rpm --target=x86_64-unknown-linux-musl -p filegen
          zip rcp-rpm-amd64-${{ env.RELEASE_TAG }}.zip target/x86_64-unknown-linux-musl/generate-rpm/*.rpm
          ls -la rcp-rpm-amd64-${{ env.RELEASE_TAG }}.zip

      - name: Upload to GitHub Release
        if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.dry_run) }}
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          files: ./rcp-rpm-amd64-${{ env.RELEASE_TAG }}.zip

  build-deb-arm64:
    runs-on: ubuntu-latest
    needs: [validate, create-release]
    if: ${{ !cancelled() && (needs.validate.result == 'success' || needs.validate.result == 'skipped') && (needs.create-release.result == 'success' || needs.create-release.result == 'skipped') }}
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c # v1

      - name: Add ARM64 target
        run: rustup target add aarch64-unknown-linux-musl

      - name: Install cross
        run: cargo install cross --locked --version 0.2.5

      - name: Install cargo-deb
        run: cargo install cargo-deb

      - name: Build with cross
        env:
          RUSTFLAGS: "--cfg tokio_unstable -C target-feature=+crt-static"
        run: cross build --release --target=aarch64-unknown-linux-musl

      - name: Build Debian packages
        run: |
          cargo deb --target=aarch64-unknown-linux-musl --no-build -p rcp-tools-rcp
          cargo deb --target=aarch64-unknown-linux-musl --no-build -p rcp-tools-rlink
          cargo deb --target=aarch64-unknown-linux-musl --no-build -p rcp-tools-rrm
          cargo deb --target=aarch64-unknown-linux-musl --no-build -p rcp-tools-rcmp
          cargo deb --target=aarch64-unknown-linux-musl --no-build -p rcp-tools-filegen
          zip rcp-deb-arm64-${{ env.RELEASE_TAG }}.zip target/aarch64-unknown-linux-musl/debian/*.deb
          ls -la rcp-deb-arm64-${{ env.RELEASE_TAG }}.zip

      - name: Upload to GitHub Release
        if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.dry_run) }}
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          files: ./rcp-deb-arm64-${{ env.RELEASE_TAG }}.zip

  build-rpm-arm64:
    runs-on: ubuntu-latest
    needs: [validate, create-release]
    if: ${{ !cancelled() && (needs.validate.result == 'success' || needs.validate.result == 'skipped') && (needs.create-release.result == 'success' || needs.create-release.result == 'skipped') }}
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c # v1

      - name: Add ARM64 target
        run: rustup target add aarch64-unknown-linux-musl

      - name: Install cross
        run: cargo install cross --locked --version 0.2.5

      - name: Install cargo-generate-rpm
        run: cargo install cargo-generate-rpm

      - name: Build with cross
        env:
          RUSTFLAGS: "--cfg tokio_unstable -C target-feature=+crt-static"
        run: cross build --release --target=aarch64-unknown-linux-musl

      - name: Build RPM packages
        run: |
          cargo generate-rpm --target=aarch64-unknown-linux-musl -p rcp
          cargo generate-rpm --target=aarch64-unknown-linux-musl -p rlink
          cargo generate-rpm --target=aarch64-unknown-linux-musl -p rrm
          cargo generate-rpm --target=aarch64-unknown-linux-musl -p rcmp
          cargo generate-rpm --target=aarch64-unknown-linux-musl -p filegen
          zip rcp-rpm-arm64-${{ env.RELEASE_TAG }}.zip target/aarch64-unknown-linux-musl/generate-rpm/*.rpm
          ls -la rcp-rpm-arm64-${{ env.RELEASE_TAG }}.zip

      - name: Upload to GitHub Release
        if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.dry_run) }}
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          files: ./rcp-rpm-arm64-${{ env.RELEASE_TAG }}.zip

  publish-release:
    runs-on: ubuntu-latest
    needs: [build-deb-amd64, build-rpm-amd64, build-deb-arm64, build-rpm-arm64]
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.dry_run) }}
    permissions:
      contents: write
    steps:
      - name: Publish Release
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          draft: false
