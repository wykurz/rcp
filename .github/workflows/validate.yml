name: Validate

on:
  workflow_call:

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: --cfg tokio_unstable

jobs:
  lint-and-docs:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c # v1
      with:
        components: rustfmt, clippy
        targets: x86_64-unknown-linux-musl

    - name: Install musl toolchain deps
      run: |
        sudo apt-get update
        sudo apt-get install -y musl-tools pkg-config
        sudo ln -sf /usr/bin/musl-gcc /usr/bin/x86_64-unknown-linux-musl-gcc

    - name: Format
      run: cargo fmt --check

    - name: Check error logging format
      run: ./scripts/check-error-logging.sh

    - name: Check anyhow::Error::msg usage
      run: ./scripts/check-anyhow-error-msg.sh

    - name: Check rust version consistency
      run: ./scripts/check-rust-version.sh

    - name: Check remote test naming
      run: ./scripts/check-remote-test-naming.sh

    - name: Lint
      run: cargo clippy --workspace --all-targets -- -D warnings
      env:
        PKG_CONFIG_ALLOW_CROSS: "1"

    - name: Documentation
      run: cargo doc --no-deps --workspace
      env:
        RUSTDOCFLAGS: --cfg tokio_unstable -D warnings
        PKG_CONFIG_ALLOW_CROSS: "1"

  test-musl-debug:
    runs-on: ubuntu-latest
    needs: lint-and-docs
    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c # v1
      with:
        targets: x86_64-unknown-linux-musl

    - name: Install musl toolchain deps
      run: |
        sudo apt-get update
        sudo apt-get install -y musl-tools pkg-config
        sudo ln -sf /usr/bin/musl-gcc /usr/bin/x86_64-unknown-linux-musl-gcc

    - name: Setup SSH for localhost
      run: |
        sudo apt-get install -y openssh-server
        sudo systemctl start ssh
        ssh-keygen -t rsa -f ~/.ssh/id_rsa -N ""
        cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
        chmod 600 ~/.ssh/authorized_keys
        ssh-keyscan -H localhost >> ~/.ssh/known_hosts

    - name: Install cargo-nextest
      run: cargo install cargo-nextest

    - name: Test (musl debug)
      env:
        PKG_CONFIG_ALLOW_CROSS: "1"
      run: |
        set -o pipefail
        # Run tests with nextest for better output
        cargo nextest run --no-capture 2>&1 | tee test_output_musl_debug.log

    - name: Test sudo-required tests (musl debug)
      env:
        PKG_CONFIG_ALLOW_CROSS: "1"
      run: |
        # Run tests that require passwordless sudo (available in CI)
        cargo nextest run --no-capture --run-ignored only -E 'test(~sudo)' 2>&1 | tee -a test_output_musl_debug.log

    - name: Doctests (musl debug)
      env:
        PKG_CONFIG_ALLOW_CROSS: "1"
      run: cargo test --doc

    - name: Upload test logs
      if: always()
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
      with:
        name: test-logs-musl-debug
        path: test_output_musl_debug.log

  test-musl-release:
    runs-on: ubuntu-latest
    needs: lint-and-docs
    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c # v1
      with:
        targets: x86_64-unknown-linux-musl

    - name: Install musl toolchain deps
      run: |
        sudo apt-get update
        sudo apt-get install -y musl-tools pkg-config
        sudo ln -sf /usr/bin/musl-gcc /usr/bin/x86_64-unknown-linux-musl-gcc

    - name: Setup SSH for localhost
      run: |
        sudo apt-get install -y openssh-server
        sudo systemctl start ssh
        ssh-keygen -t rsa -f ~/.ssh/id_rsa -N ""
        cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
        chmod 600 ~/.ssh/authorized_keys
        ssh-keyscan -H localhost >> ~/.ssh/known_hosts

    - name: Install cargo-nextest
      run: cargo install cargo-nextest

    - name: Test (musl release)
      env:
        PKG_CONFIG_ALLOW_CROSS: "1"
      run: |
        set -o pipefail
        # Run tests with nextest in release mode
        cargo nextest run --release --no-capture 2>&1 | tee test_output_musl_release.log

    - name: Test sudo-required tests (musl release)
      env:
        PKG_CONFIG_ALLOW_CROSS: "1"
      run: |
        # Run tests that require passwordless sudo (available in CI)
        cargo nextest run --release --no-capture --run-ignored only -E 'test(~sudo)' 2>&1 | tee -a test_output_musl_release.log

    - name: Doctests (musl release)
      env:
        PKG_CONFIG_ALLOW_CROSS: "1"
      run: cargo test --doc --release

    - name: Upload test logs
      if: always()
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
      with:
        name: test-logs-musl-release
        path: test_output_musl_release.log

  test-docker:
    runs-on: ubuntu-latest
    needs: lint-and-docs
    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c # v1
      with:
        targets: x86_64-unknown-linux-musl

    - name: Install musl toolchain deps
      run: |
        sudo apt-get update
        sudo apt-get install -y musl-tools pkg-config
        sudo ln -sf /usr/bin/musl-gcc /usr/bin/x86_64-unknown-linux-musl-gcc

    - name: Install just
      uses: taiki-e/install-action@90558ad1e179036f31467972b00dec6cb80701fa # v2
      with:
        tool: just

    - name: Install cargo-nextest
      uses: taiki-e/install-action@90558ad1e179036f31467972b00dec6cb80701fa # v2
      with:
        tool: cargo-nextest

    - name: Build binaries for Docker
      env:
        PKG_CONFIG_ALLOW_CROSS: "1"
      run: cargo build --workspace

    - name: Start Docker containers
      run: |
        cd tests/docker
        docker compose up -d

        # Wait for containers to be healthy and SSH to be ready
        echo "Waiting for containers to start..."
        sleep 3

        # Check if SSH daemon is running in containers
        echo "Checking SSH daemon status..."
        docker exec rcp-test-master pgrep sshd || echo "SSH not running in master"
        docker exec rcp-test-host-a pgrep sshd || echo "SSH not running in host-a"
        docker exec rcp-test-host-b pgrep sshd || echo "SSH not running in host-b"

        # Wait for SSH connectivity (with timeout)
        echo "Testing SSH connectivity from master to host-a..."
        TIMEOUT=60
        ELAPSED=0
        until docker exec -u testuser rcp-test-master ssh -o ConnectTimeout=5 host-a hostname &> /dev/null; do
          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "ERROR: SSH connectivity timeout after ${TIMEOUT}s"
            docker exec -u testuser rcp-test-master ssh -v host-a hostname 2>&1 || true
            docker compose logs
            exit 1
          fi
          echo "Waiting for SSH... (${ELAPSED}s/${TIMEOUT}s)"
          sleep 2
          ELAPSED=$((ELAPSED + 2))
        done
        echo "SSH connectivity confirmed"

    - name: Run Docker multi-host tests
      run: cargo nextest run --profile docker --run-ignored only

    - name: Show Docker logs on failure
      if: failure()
      run: |
        cd tests/docker
        docker compose logs

    - name: Stop Docker containers
      if: always()
      run: |
        cd tests/docker
        docker compose down

  build-glibc:
    runs-on: ubuntu-latest
    needs: lint-and-docs
    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c # v1

    - name: Build all binaries (glibc)
      run: cargo build --workspace --release --target x86_64-unknown-linux-gnu
